# some SQL code examples

## tips about shell usage

If you decided to use tools like `sqlcmd`, for example, you could first check the version of `SQL Server` with the following command:

```shell
sqlcmd -S 127.0.0.1 -U SA -N -C -Q 'select @@VERSION'
```

For example, you could connect to the database server with the following command:

```shell
sqlcmd -S 127.0.0.1 -U SA -N -C
```

## some possible examples of writing Transact-SQL statements and queries

**If you want to use this command, remember to read the license and always type the `go` command on a new line.**

### you may want to view the list of usernames present in the system

```sql
select name from sys.sysusers;
go
```

### you may want to view the list of databases present in the system

```sql
select name from sys.databases;
go
```

### you may want to create a new database

```sql
-- create a database named `TestDb`
create database TestDb;
go

-- if you want to see a list of databases
select Name from sys.databases;
go

-- move to the database `TestDb`
use TestDb;
go

-- create a new schema named `TestV1Sc` inside it
create schema TestV1Sc;
go

-- if you want to see a list of the schemes
select distinct schema_name from information_schema.schemata;
go

-- create table `Inventory` inside schema `TestV1Sc`, with a certain record track
create table TestV1Sc.Inventory (id int, name nvarchar(32), description nvarchar(128), quantity int, primary key (id));
go

-- insert some sample data into the table you just created
insert into TestV1Sc.Inventory (id, name, description, quantity) values (1, 'carrot', 'vegetable', 145), (2, 'banana', 'fruit', 210), (3, 'spinach', 'vegetable', 145), (4, 'strawberry', 'fruit', 100), (5, 'broccoli', 'vegetable', 200), (6, 'mango', 'fruit', 120), (7, 'zucchini', 'vegetable', 145), (8, 'orange', 'fruit', 130);
go

-- do some data extractions
select * from TestV1Sc.Inventory;
go

select * from TestV1Sc.Inventory where quantity > 140;
go

select * from TestV1Sc.Inventory where quantity between 150 and 200;
go

-- delete the test database
drop database TestDb;
go

-- If you want to see a list of registered users
select name as NomeLogin, type_desc as TipoLogin, create_date as DataCreazione from sys.server_principals where type_desc in ('SQL_LOGIN', 'WINDOWS_LOGIN', 'WINDOWS_GROUP');
go

-- exit the interactive session
quit
```

## at this point you might want to do something more challenging

### you may want to create a new user for a new database

```sql
-- database creation
create database ExampleDb;
go

-- use the newly created database
use ExampleDb;
go

-- check
select db_name();
go

-- creating login, (the following command should only be used once)
create login newly_username with password = 'secure_password';
go

-- creating user in database, (the following command should be used for each database)
create user newly_username for login newly_username;
go

-- adding user to a role, (the following command should be used for each database)
exec sp_addrolemember @rolename = 'db_owner', @membername = 'newly_username';
go

quit
```

Then you could access with the new username just recorded in the RDBMS:

```sql
-- check
select db_name();
go

use ExampleDb;
go

-- if you want to create a schema in the new database
create schema ExampleV1Sc;
go

-- check
select * from sys.schemas;
go

-- if you want to create table `Users` in schema `ExampleV1Sc`
create table ExampleV1Sc.Users (IdUser bigint primary key identity(1,1), NameUser nvarchar(64) not null unique, PwUser nvarchar(128) not null unique, IsAuthorized bit default 1, CreatedAt datetime2 default getdate(), UpdatedAt datetime2 default getdate());
go

-- if you want to create an index for table `Users`
create index IX_NameUser on ExampleV1Sc.Users(NameUser);
go

-- check
select * from ExampleV1Sc.Users;
go

-- if you want to create table `Intents` in schema `ExampleV1Sc`
create table ExampleV1Sc.Intents (IdIntent bigint primary key identity(1,1), TitleIntent nvarchar(256) not null unique, DescriptionIntent nvarchar(max) default 'description of the purpose or scope to be defined', Color nvarchar(16) default '#eeeeee', IsValid bit default 1, CreatedAt datetime2 default getdate(), UpdatedAt datetime2 default getdate());
go

-- if you want to create an index for table `Intents`
create index IX_TitleIntent on ExampleV1Sc.Intents(TitleIntent);
go

-- check
select * from ExampleV1Sc.Intents;
go

-- if you want to create table `Projects` in schema `ExampleV1Sc`
create table ExampleV1Sc.Projects (IdProject bigint primary key identity(1,1), TitleProject nvarchar(256) not null unique, DescriptionProject nvarchar(max) default 'description of the task or assignment to be performed', IsUrgent bit default 0, IsDone bit default 0, IsCanceled bit default 0, IntentId bigint not null, UserId bigint not null, Deadline datetime2 default dateadd(day, 1, getdate()), CreatedAt datetime2 default getdate(), UpdatedAt datetime2 default getdate(), constraint FK_ProjectIntent foreign key (IntentId) references ExampleV1Sc.Intents(IdIntent) on delete no action on update no action, constraint FK_ProjectUser foreign key (UserId) references ExampleV1Sc.Users(IdUser) on delete no action on update no action);
go

-- check
select * from ExampleV1Sc.Projects;
go

-- if you want to check the schemas and tables present in a given database
select table_schema as SchemaName, table_name as TableName from information_schema.tables where table_type = 'BASE TABLE';
go

-- or, similarly to the above
select s.name as SchemaName, t.name as TableName from sys.schemas as s join sys.tables as t on s.schema_id = t.schema_id order by s.name, t.name;
go

-- if you want to see the indexes of a specific table, you can use the following query
select i.name as IndexName, i.type_desc as IndexType, t.name as TableName, s.name as SchemaName, i.is_primary_key as IsPrimaryKey, i.is_unique as IsUnique, i.is_disabled as IsDisabled from sys.indexes as i join sys.tables as t on i.object_id = t.object_id join sys.schemas as s on t.schema_id = s.schema_id where t.name = 'Users' order by t.name, i.name;
```

### now you may want to enter some test data

Table ExampleV1Sc.Users

```sql
-- insertion fictitious data in table Users
insert into ExampleV1Sc.Users (NameUser, PwUser, IsAuthorized) values ('alice', 'alice&123pw', 1), ('bob', 'bob&123pw', 1), ('david', 'david&123pw', 1), ('charlie', 'charlie&123pw', 1), ('eve', 'eve&123pw', 1), ('ethan', 'ethan&123pw', 1), ('diana', 'diana&123pw', 0), ('lilly', 'lilly&123pw', 1), ('james', 'james&123pw', 0), ('john', 'john&123pw', 1);
go

select * from ExampleV1Sc.Users;
go

-- insertion fictitious data in table Intents
insert into ExampleV1Sc.Intents (TitleIntent, DescriptionIntent, Color, IsValid) values ('Example intent number one', 'Example of description for intent number one.', '#ffcc00', 1), ('Example intent number two', 'Example of description for intent number two.', '#ee0033', 1), ('Example intent number three', 'Example of description for intent number three.', '#00ff00', 1), ('Example intent number four', 'Example of non-valid intent.', '#ccccff', 0), ('Example intent number five', 'Example of description for intent number five.', '#ff00cc', 1), ('Example intent number six', 'Example of description for intent number six.', '#0000ff', 1);
go

select * from ExampleV1Sc.Intents;
go

-- since for the Deadline value you must spend the number of days that are missing at the expiry and not the date in string format, it will be necessary to create a store procedure
create procedure ExampleV1Sc.InsertProject @TitleProject nvarchar(256), @DescriptionProject nvarchar(max), @IsUrgent bit, @IsDone bit, @IsCanceled bit, @IntentId bigint, @UserId bigint, @Deadline int as begin insert into ExampleV1Sc.Projects (TitleProject, DescriptionProject, IsUrgent, IsDone, IsCanceled, IntentId, UserId, Deadline) values (@TitleProject, @DescriptionProject, @IsUrgent, @IsDone, @IsCanceled, @IntentId, @UserId, dateadd(day, @Deadline, getdate())) end;
go

-- check
select schema_name(schema_id) as SchemaName, name as ProcedureName, type_desc as TypeDescription from sys.procedures order by SchemaName, ProcedureName;
go

-- insertion fictitious data in table Projects
exec ExampleV1Sc.InsertProject @TitleProject = 'Bug Fix sample one', @DescriptionProject = 'Fix critical bug in the sample one', @IsUrgent = 1, @IsDone = 1, @IsCanceled = 0, @IntentId = 1, @UserId = 3, @Deadline = 21;
go

exec ExampleV1Sc.InsertProject @TitleProject = 'Client issue resolution sample one', @DescriptionProject = 'Resolve client support ticket sample one', @IsUrgent = 0, @IsDone = 0, @IsCanceled = 1, @IntentId = 2, @UserId = 10, @Deadline = 28;
go

exec ExampleV1Sc.InsertProject @TitleProject = 'Bug Fix sample two', @DescriptionProject = 'Fix critical bug in the sample two', @IsUrgent = 0, @IsDone = 0, @IsCanceled = 0, @IntentId = 5, @UserId = 8, @Deadline = 25;
go

exec ExampleV1Sc.InsertProject @TitleProject = 'Client issue resolution sample two', @DescriptionProject = 'Resolve client support ticket sample two', @IsUrgent = 1, @IsDone = 1, @IsCanceled = 0, @IntentId = 2, @UserId = 6, @Deadline = 10;
go

exec ExampleV1Sc.InsertProject @TitleProject = 'Data analysis report sample two', @DescriptionProject = 'Data analysis report for example two', @IsUrgent = 1, @IsDone = 0, @IsCanceled = 0, @IntentId = 6, @UserId = 3, @Deadline = 3;
go

exec ExampleV1Sc.InsertProject @TitleProject = 'Client issue resolution sample three', @DescriptionProject = 'Resolve client support ticket sample three', @IsUrgent = 0, @IsDone = 1, @IsCanceled = 0, @IntentId = 5, @UserId = 4, @Deadline = 7;
go

exec ExampleV1Sc.InsertProject @TitleProject = 'Data analysis report sample one', @DescriptionProject = 'Data analysis report for example one', @IsUrgent = 0, @IsDone = 0, @IsCanceled = 0, @IntentId = 2, @UserId = 5, @Deadline = 12;
go

exec ExampleV1Sc.InsertProject @TitleProject = 'Client issue resolution sample four', @DescriptionProject = 'Resolve client support ticket sample four', @IsUrgent = 1, @IsDone = 0, @IsCanceled = 0, @IntentId = 3, @UserId = 10, @Deadline = 5;
go

exec ExampleV1Sc.InsertProject @TitleProject = 'Client issue resolution sample five', @DescriptionProject = 'Resolve client support ticket sample five', @IsUrgent = 0, @IsDone = 0, @IsCanceled = 1, @IntentId = 1, @UserId = 2, @Deadline = 21;
go

exec ExampleV1Sc.InsertProject @TitleProject = 'Client issue resolution sample six', @DescriptionProject = 'Resolve client support ticket sample six', @IsUrgent = 0, @IsDone = 0, @IsCanceled = 0, @IntentId = 5, @UserId = 5, @Deadline = 14;
go

exec ExampleV1Sc.InsertProject @TitleProject = 'Bug Fix sample three', @DescriptionProject = 'Fix critical bug in the sample three', @IsUrgent = 0, @IsDone = 0, @IsCanceled = 0, @IntentId = 6, @UserId = 4, @Deadline = 7;
go

select * from ExampleV1Sc.Projects;
go

-- to see the latest number of index entered
select ident_current('ExampleV1Sc.Projects');
go
```

### you may want to creatively extract some data from the sample database

```sql
-- perhaps you might want to create a view like the following that correlates users and projects
create view ExampleV1Sc.UserProjectsView as select U.NameUser, P.TitleProject, P.IsUrgent, P.IsDone, P.Deadline, I.TitleIntent as IntentTitle, I.Color from ExampleV1Sc.Users U join ExampleV1Sc.Projects P on U.IdUser = P.UserId join ExampleV1Sc.Intents I on P.IntentId = I.IdIntent where P.IsDone = 0;
go

select * from ExampleV1Sc.UserProjectsView;
go

-- it may be necessary to see the details of each project
create view ExampleV1Sc.ProjectDetailsView as select P.IdProject, P.TitleProject, P.DescriptionProject, P.IsUrgent, P.IsDone, P.IsCanceled, P.Deadline, P.CreatedAt as ProjectCreatedAt, P.UpdatedAt as ProjectUpdatedAt, U.IdUser, U.NameUser, I.IdIntent, I.TitleIntent, I.Color, I.IsValid from ExampleV1Sc.Projects P join ExampleV1Sc.Users U on P.UserId = U.IdUser join ExampleV1Sc.Intents I on P.IntentId = I.IdIntent;
go

select * from ExampleV1Sc.ProjectDetailsView;
go

-- perhaps, using the newly created view, you may need to check which projects are urgent, unfinished and not cancelled
select * from ExampleV1Sc.ProjectDetailsView where IsUrgent = 1 and IsDone = 0 and IsCanceled = 0 order by Deadline;
go

-- additionally, it might be helpful to know the project count for each user/employee
create view ExampleV1Sc.NumberOfProjectsForEachEmployeeView as select U.NameUser, count(P.IdProject) as NumProjects, sum(case when P.IsDone = 1 then 1 else 0 end) as NumDone, sum(case when P.IsCanceled = 1 then 1 else 0 end) as NumCanceled from ExampleV1Sc.Users U left join ExampleV1Sc.Projects P on P.UserId = U.IdUser group by U.NameUser;
go

select * from ExampleV1Sc.NumberOfProjectsForEachEmployeeView order by NumProjects desc;
go

-- or using the project details view you could check which projects are due within the next ten days
create view ExampleV1Sc.ProjectsExpiringView as select P.IdProject, P.TitleProject, U.NameUser, I.TitleIntent, P.Deadline from ExampleV1Sc.ProjectDetailsView P join ExampleV1Sc.Users U on P.IdUser = U.IdUser join ExampleV1Sc.Intents I on P.IdIntent = I.IdIntent where P.Deadline <= dateadd(day, 10, getdate()) and P.Deadline >= getdate();
go

select * from ExampleV1Sc.ProjectsExpiringView order by Deadline;
go
```
